/**
 * Copyright 2003-2004 Sun Microsystems, Inc. All rights reserved.
 * Use is subject to license terms.
 * -----------------------------------------------------------------------------
 *  Generated from java_event_factory.jsp
 *  !!! DO NOT EDIT THIS FILE !!!
 */
<%
  final com.sun.grid.cull.JavaHelper jh = (com.sun.grid.cull.JavaHelper)params.get("javaHelper");
  com.sun.grid.cull.CullDefinition cullDef = (com.sun.grid.cull.CullDefinition)params.get("cullDef");
  
  
  class SubscribeMethodGenerator {
     
     private com.sun.grid.cull.CullObject cullObj;
     private String eventName;
     private String name;
     
     
     public void setObj(com.sun.grid.cull.CullObject cullObj) {
      
         this.cullObj = cullObj;
         name = cullObj.getIdlName();
         
         if(name == null) {
            throw new IllegalStateException("Have no idl name for " + cullObj.getName());
         }
      
         eventName = getEventName(cullObj);
     }

     public String getModEventName(com.sun.grid.cull.CullObject obj) {
        if(obj.getName().equals("SC_Type")) {
           return "sgeE_SCHED_CONF";
        }
        return "sgeE_" + getEventName(obj) + "_MOD";
     }
     
     public String getAddEventName(com.sun.grid.cull.CullObject obj) {
        return "sgeE_" + getEventName(obj) + "_ADD";
     }
     
     public String getDelEventName(com.sun.grid.cull.CullObject obj) {
        return "sgeE_" + getEventName(obj) + "_DEL";
     }

     public String getListEventName(com.sun.grid.cull.CullObject obj) {
        return "sgeE_" + getEventName(obj) + "_LIST";
     }
     
     private String getEventName(com.sun.grid.cull.CullObject obj) {
        
        String listname = obj.getListName();

        if(listname == null) {
           throw new IllegalArgumentException("cull object" + obj.getName() + " has no list");
        }
        int si = listname.indexOf('_');
        int ei = listname.lastIndexOf('_');
      
        return listname.substring(si+1, ei);
     }
     
     public void generate() {
        if (this.cullObj.hasAddOperation()) {
           generate("Add" + name, getAddEventName(cullObj));
           generateFlush("Add" + name, getAddEventName(cullObj));
        }
        if (this.cullObj.hasDeleteOperation()) {
           generate("Del" + name, getDelEventName(cullObj));
           generateFlush("Del" + name, getDelEventName(cullObj));
        }
        if (this.cullObj.hasGetListOperation()) {
           generate("List" + name, getListEventName(cullObj));
           generateFlush("List" + name, getListEventName(cullObj));
        }
        if (this.cullObj.hasModifyOperation()) {
           generate("Mod" + name, getModEventName(cullObj));
           generateFlush("Mod" + name, getModEventName(cullObj));
        }
     }
     
     public void generate(String methodSuffix, String eventName) {
        
%>
JNIEXPORT void JNICALL Java_com_sun_grid_jgdi_jni_EventClientImpl_nativeSubscribe<%=methodSuffix%>(JNIEnv *env, jobject evcobj, jboolean subscribe)
{
   lList *alp = NULL;
   sge_evc_class_t *sge_evc = NULL;
   jgdi_result_t ret = JGDI_SUCCESS;

   DENTER(JGDI_LAYER, "Java_com_sun_grid_jgdi_jni_EventClientImpl_nativeSubscribe<%=methodSuffix%>");

   if ((ret = getEVC(env, evcobj, &sge_evc, &alp)) != JGDI_SUCCESS) {
      throw_error_from_answer_list(env, ret, alp);
      DEXIT;
      return;
   }

   if (subscribe == true) {
      DPRINTF(("event client (%d) subscribes <%=eventName%>\n", sge_evc->ec_get_id(sge_evc)));
      if (!sge_evc->ec_subscribe(sge_evc, <%=eventName%>)) {
         THROW_ERROR((env, JGDI_ERROR, "ec_subscribe %d failed", <%=eventName%>));
         DEXIT;
         return;
      }
   } else {
      DPRINTF(("event client (%d) unsubscribes <%=eventName%>\n", sge_evc->ec_get_id(sge_evc)));
      if (!sge_evc->ec_unsubscribe(sge_evc, <%=eventName%>)) {
         THROW_ERROR((env, JGDI_ERROR, "ec_unsubscribe %d failed", <%=eventName%>));
         DEXIT;
         return;
      }
   }
   DEXIT;
}
<%
        
     } // end of generate
     
     
     public void generateFlush(String method, String eventName) {
        
%>
JNIEXPORT void JNICALL Java_com_sun_grid_jgdi_jni_EventClientImpl_nativeSet<%=method%>Flush(JNIEnv *env, jobject evcobj, jboolean flush, jint interval) {
   
   lList *alp = NULL;
   sge_evc_class_t *sge_evc = NULL;
   jgdi_result_t ret = JGDI_SUCCESS;

   DENTER(JGDI_LAYER, "Java_com_sun_grid_jgdi_jni_EventClientImpl_nativeSet<%=method%>Flush");

   if ((ret = getEVC(env, evcobj, &sge_evc, &alp)) != JGDI_SUCCESS) {
      throw_error_from_answer_list(env, ret, alp);
      DEXIT;
      return;
   }

   if (!sge_evc->ec_set_flush(sge_evc, <%=eventName%>, (bool)flush, (u_long32)interval) ) {
      THROW_ERROR((env, JGDI_ERROR, "ec_set_flush failed"));
      DEXIT;
      return;
   }

   DEXIT;
}

JNIEXPORT jint JNICALL Java_com_sun_grid_jgdi_jni_AbstractEventClient_nativeGet<%=method%>Flush(JNIEnv *env, jobject evcobj) {
   
   lList *alp = NULL;
   sge_evc_class_t *sge_evc = NULL;
   jgdi_result_t ret = JGDI_SUCCESS;
   jint result = 0;
   DENTER(JGDI_LAYER, "Java_com_sun_grid_jgdi_jni_AbstractEventClient_nativeGet<%=method%>Flush");

   if ((ret = getEVC(env, evcobj, &sge_evc, &alp)) != JGDI_SUCCESS) {
      throw_error_from_answer_list(env, ret, alp);
      DEXIT;
      return 0;
   }

   result = (jint)sge_evc->ec_get_flush(sge_evc, <%=eventName%>);
   
   DEXIT;
   return result;
}

<%
        
     } // end of generate flush
     
     
  } // end of class SubscribeMethodGenerator
  
%>
#include <ctype.h>
#include <string.h>
#include "jni.h"
#include "jgdi.h"
#include "basis_types.h"
#include "cull.h"
#include "commlib.h"
#include "sgermon.h"
#include "sge_all_listsL.h"
#include "sge_answer.h"
#include "sge_prog.h"
#include "sge_bootstrap.h"
#include "sge_gdi.h"
#include "sge_gdi_ctx.h"
#include "sge_gdi2.h"
#include "cl_errors.h"
#include "setup.h"
#include "sge_log.h"
#include "sge_error_class.h"
#include "jgdi_common.h"
#include "sge_event_client2.h"
#include "jgdi_event.h"
#include "sge_mirror.h"
#include "sge_eventL.h"
#include "jgdi_wrapper.h"

<%
    java.util.Iterator iter = cullDef.getObjectNames().iterator();
    com.sun.grid.cull.CullObject cullObj = null;
    String name = null;
    
    SubscribeMethodGenerator gen = new SubscribeMethodGenerator();

    while( iter.hasNext() ) {
      name = (String)iter.next();
      cullObj = cullDef.getCullObject(name); 
      
      gen.setObj(cullObj);
      
      gen.generate();
      
   } // end of while 
%>

jgdi_result_t process_generic_event(JNIEnv *env,  jobject *event, lListElem *ev, lList** alpp) {

   switch( lGetUlong(ev, ET_type)) {
<%
   iter = cullDef.getObjectNames().iterator();
    while( iter.hasNext() ) {
      name = (String)iter.next();
      cullObj = cullDef.getCullObject(name); 
      
      String eventName = gen.getEventName(cullObj);     
      String classname = jh.getFullClassName(cullObj).replace('.', '/');
      
      if(cullObj.hasModifyOperation()) {
%>
      case <%=gen.getModEventName(cullObj)%>:
         return create_generic_event(env, event,"<%=classname%>", "<%=cullObj.getName()%>", <%=cullObj.getName()%>, SGE_EMA_MOD, ev, alpp);
<%
      }
      if(cullObj.hasGetListOperation()) {
%>      
      case <%=gen.getListEventName(cullObj)%>:
         return create_generic_event(env, event,"<%=classname%>", "<%=cullObj.getName()%>", <%=cullObj.getName()%>, SGE_EMA_LIST, ev, alpp);
<%
      }
      if(cullObj.hasDeleteOperation()) {
%>      
      case <%=gen.getDelEventName(cullObj)%>:
         return create_generic_event(env, event,"<%=classname%>", "<%=cullObj.getName()%>", <%=cullObj.getName()%>, SGE_EMA_DEL, ev, alpp);
<%
      }
      if(cullObj.hasAddOperation()) {
%>      
      case <%=gen.getAddEventName(cullObj)%>:
         return create_generic_event(env, event,"<%=classname%>", "<%=cullObj.getName()%>", <%=cullObj.getName()%>, SGE_EMA_ADD, ev, alpp);
<%
      }
   } // end of while      
%>  
      default:
         answer_list_add_sprintf(alpp, STATUS_EUNKNOWN, ANSWER_QUALITY_ERROR, 
                                 "Event action not yet handled %d",  lGetUlong(ev, ET_type));
         return JGDI_ERROR;
   }

}

